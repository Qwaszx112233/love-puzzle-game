<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üíñ Love Number Puzzle üíñ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%);
      min-height: 100vh;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    /* –≠–∫—Ä–∞–Ω—ã */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: opacity 0.3s ease;
    }

    .screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
    .main-menu {
      text-align: center;
      gap: 30px;
    }

    .game-title {
      font-size: 2.8rem;
      font-weight: bold;
      color: #e91e63;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .romantic-subtitle {
      font-size: 1.3rem;
      color: #e91e63;
      margin-bottom: 40px;
      font-weight: bold;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 280px;
    }

    .menu-btn {
      padding: 18px 25px;
      background: linear-gradient(45deg, #e91e63, #ff4081);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
    }

    .menu-btn:active {
      transform: scale(0.95);
    }

    .menu-btn.secondary {
      background: white;
      color: #e91e63;
      border: 3px solid #f8bbd9;
    }

    /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
    .game-screen {
      justify-content: flex-start;
      padding: 15px;
      gap: 10px;
    }

    .game-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 5px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .home-btn {
      padding: 10px 15px;
      background: white;
      color: #e91e63;
      border: 2px solid #f8bbd9;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
    }

    .header {
      font-size: 1.3rem;
      font-weight: bold;
      color: #e91e63;
      text-align: center;
      flex: 1;
    }

    .love-message {
      background: white;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #f8bbd9;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .message-text {
      font-size: 1rem;
      font-weight: 600;
      color: #880e4f;
      text-align: center;
      line-height: 1.3;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
    }

    .stat-item {
      background: white;
      padding: 8px 12px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
      font-weight: bold;
      color: #880e4f;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(233, 30, 99, 0.1);
    }

    .xp-bar {
      width: 100%;
      height: 16px;
      background: #ffeef2;
      border-radius: 8px;
      border: 2px solid #f8bbd9;
      overflow: hidden;
      margin: 5px 0;
    }

    .xp-bar-inner {
      height: 100%;
      background: linear-gradient(45deg, #e91e63, #ff4081);
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .xp-bar-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      color: #880e4f;
    }

    .bonuses {
      display: flex;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin: 5px 0;
    }

    .bonus-btn {
      padding: 10px 12px;
      background: #ffeef2;
      border: 2px solid #f8bbd9;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: bold;
      color: #880e4f;
      cursor: pointer;
      flex: 1;
      max-width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .bonus-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .bonus-btn:disabled {
      opacity: 0.5;
    }

    .bonus-btn.active {
      background: #e91e63;
      color: white;
    }

    .bonus-cost {
      font-size: 0.8rem;
      color: #e91e63;
      font-weight: bold;
    }

    .grid-container {
      flex: 1;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 0;
      max-height: 380px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 6px;
      background: white;
      border-radius: 15px;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      height: 100%;
      max-height: 100%;
      box-shadow: 0 4px 15px rgba(233, 30, 99, 0.2);
    }

    .cell {
      background: #ffeef2;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: bold;
      color: #880e4f;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      min-height: 50px;
      user-select: none;
    }

    .cell.selected {
      background: #ff4081;
      color: white;
      transform: scale(0.92);
      border-color: #e91e63;
    }

    .cell.merged {
      background: #e91e63;
      color: white;
      animation: pop 0.3s ease;
    }

    @keyframes pop {
      0% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .controls {
      display: flex;
      gap: 10px;
      width: 100%;
      margin-top: 10px;
    }

    .btn {
      padding: 14px 20px;
      background: linear-gradient(45deg, #e91e63, #ff4081);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      transition: transform 0.2s;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn.back-btn {
      background: white;
      color: #e91e63;
      border: 2px solid #f8bbd9;
    }

    /* –ü–ª–∞–≤–∞—é—â–∏–µ —Å–µ—Ä–¥–µ—á–∫–∏ */
    .floating-hearts {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .floating-heart {
      position: absolute;
      font-size: 1.5rem;
      opacity: 0.1;
      animation: float 15s linear infinite;
    }

    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(100px, 100px) rotate(360deg); }
    }

    .hearts {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .heart {
      position: absolute;
      font-size: 1.2rem;
      opacity: 0;
      animation: heartFloat 2s ease-in-out forwards;
    }

    @keyframes heartFloat {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-40px) rotate(360deg); opacity: 0; }
    }

    /* –ß–∞—Å—Ç–∏—Ü—ã */
    .romantic-particle {
      position: fixed;
      pointer-events: none;
      font-size: 1.5rem;
      z-index: 1000;
      animation: particleFloat 3s ease-in-out forwards;
    }

    @keyframes particleFloat {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg) scale(0.5); opacity: 0; }
    }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
    .swipe-hint {
      text-align: center;
      color: #e91e63;
      font-weight: bold;
      font-size: 0.9rem;
      margin: 5px 0;
    }

    /* –¶–≤–µ—Ç–∞ —á–∏—Å–µ–ª */
    .cell[data-number="2"] { background: #ffb6c1; }
    .cell[data-number="4"] { background: #ffd700; }
    .cell[data-number="8"] { background: #98fb98; }
    .cell[data-number="16"] { background: #87ceeb; }
    .cell[data-number="32"] { background: #da70d6; }
    .cell[data-number="64"] { background: #ffa07a; }
    .cell[data-number="128"] { background: #f0e68c; }
    .cell[data-number="256"] { background: #dda0dd; }
    .cell[data-number="512"] { background: #b0e0e6; }
    .cell[data-number="1024"] { background: #ffb347; }

    /* –ü–æ–±–µ–¥–∞ */
    .victory-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .victory-overlay.hidden {
      display: none;
    }

    .victory-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(233, 30, 99, 0.3);
      text-align: center;
      max-width: 90%;
    }

    .victory-title {
      font-size: 2.2rem;
      color: #e91e63;
      margin-bottom: 20px;
    }

    .victory-message {
      font-size: 1.2rem;
      color: #880e4f;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <!-- –ü–ª–∞–≤–∞—é—â–∏–µ —Å–µ—Ä–¥–µ—á–∫–∏ -->
  <div class="floating-hearts" id="floatingHearts"></div>
  <div id="romanticParticles"></div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div class="screen" id="mainMenuScreen">
    <div class="main-menu">
      <div class="game-title">üíñ Love Puzzle üíñ</div>
      <div class="romantic-subtitle">–î–ª—è –º–æ—î—ó –Ω–∞–π–∫—Ä–∞—â–æ—ó –¥—Ä—É–∂–∏–Ω–∏</div>
      <div class="menu-buttons">
        <button class="menu-btn" id="playBtn">üéÆ –ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
        <button class="menu-btn secondary" id="settingsBtn">üíù –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        <button class="menu-btn secondary" id="aboutBtn">üåπ –ü—Ä–æ –≥—Ä—É</button>
      </div>
    </div>
  </div>

  <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="game-header">
      <div class="header-top">
        <button class="home-btn" id="homeBtn">üè†</button>
        <div class="header">–ú–æ—è –ª—é–±–æ–≤! üíï</div>
      </div>
      <div class="love-message">
        <div class="hearts" id="hearts"></div>
        <div class="message-text" id="messageText">–ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –ø–æ —á–∏—Å–ª–∞—Ö –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–∞–Ω—Ü—é–∂–∫–∞</div>
      </div>
      <div class="stats">
        <div class="stat-item">–†—ñ–≤–µ–Ω—å: <span id="currentLevel">1</span></div>
        <div class="stat-item">–¶—ñ–ª—å: <span id="targetValue">64</span></div>
        <div class="stat-item">–§—Ä–∞–∑: <span id="messageCount">0</span></div>
      </div>
    </div>

    <div class="xp-bar">
      <div class="xp-bar-inner" id="xpBar">
        <div class="xp-bar-text" id="xpText">0/10</div>
      </div>
    </div>

    <div class="bonuses">
      <button class="bonus-btn" id="bonus-destroy">
        üíñ –†–æ–∑–±–∏—Ç–∏
        <span class="bonus-cost">5</span>
      </button>
      <button class="bonus-btn" id="bonus-shuffle">
        üîÑ –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏
        <span class="bonus-cost">10</span>
      </button>
      <button class="bonus-btn" id="bonus-explosion">
        üí• –í–∏–±—É—Ö
        <span class="bonus-cost">20</span>
      </button>
    </div>

    <div class="swipe-hint">üëÜ –ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –ø–æ —á–∏—Å–ª–∞—Ö</div>

    <div class="grid-container">
      <div class="grid" id="grid"></div>
    </div>

    <div class="controls">
      <button class="btn back-btn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="btn" id="resetBtn">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
      <button class="btn" id="nextLevelBtn">‚≠ê –î–∞–ª—ñ</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã -->
  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title">üíù –í—ñ—Ç–∞—é! üíù</div>
      <div class="victory-message" id="victoryMessage">–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞! üíñ</div>
      <div class="menu-buttons">
        <button class="menu-btn" id="playAgainBtn">üíï –ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="menu-btn secondary" id="closeWebAppBtn">üòò –ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing Love Puzzle...');

      class LoveNumberPuzzle {
        constructor() {
          this.levels = this.generateLevels(30);
          this.MAX_LEVEL = this.levels.length;
          
          this.loveMessages = [
            "–¢–∏ - –º–æ—î —Å–æ–Ω–µ—á–∫–æ, —â–æ –æ—Å–≤—ñ—Ç–ª—é—î –∫–æ–∂–µ–Ω –º—ñ–π –¥–µ–Ω—å üåû",
            "–ö–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —Å—Ç–∞—î —Å–∏–ª—å–Ω—ñ—à–∏–º üíñ",
            "–¢–≤–æ—ó –æ—á—ñ - —Ü–µ –∑—ñ—Ä–∫–∏, —â–æ –≤–∫–∞–∑—É—é—Ç—å –º–µ–Ω—ñ —à–ª—è—Ö ‚ú®",
            "–ó —Ç–æ–±–æ—é –∫–æ–∂–Ω–∞ –º–∏—Ç—å - —Ü–µ –∫–∞–∑–∫–∞ üè∞",
            "–¢–∏ - –Ω–∞–π–Ω—ñ–∂–Ω—ñ—à–∞ –º—Ä—ñ—è –º–æ—î—ó –¥—É—à—ñ üí≠",
            "–¢–≤–æ—ó –æ–±—ñ–π–º–∏ - –º—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç ü§ó",
            "–ö–æ–∂–Ω–∞ —á–∞—Å—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ —á–∞—Ä—ñ–≤–Ω–∞ ü™Ñ",
            "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–æ–ª–æ–¥—à–∏–º üçØ",
            "–¢–∏ - –º–æ—è —É–ª—é–±–ª–µ–Ω–∞ –ø–∞–Ω–¥–∞ —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –ø–∞–Ω–¥ üêº",
            "–õ—é–±–ª—é —Ç–µ–±–µ —Å–∏–ª—å–Ω—ñ—à–µ, –Ω—ñ–∂ –∫–æ—Ç–∏ –ª—é–±–ª—è—Ç—å –∫–æ—Ä–æ–±–∫–∏ üì¶",
            "–¢–∏ - –º–æ—î —â–∞—Å—Ç—è, —è–∫ –º–æ—Ä–æ–∑–∏–≤–æ –≤ —Å–ø–µ–∫–æ—Ç–Ω–∏–π –¥–µ–Ω—å üç¶",
            "–¢–≤–æ—è –ø–æ—Å–º—ñ—à–∫–∞ - –Ω–∞–π–∫—Ä–∞—Å–∏–≤—ñ—à–∏–π –ø–µ–π–∑–∞–∂ üòä",
            "–õ—é–±–æ–≤ –¥–æ —Ç–µ–±–µ - –≤—ñ—á–Ω–∞ —ñ –±–µ–∑–º–µ–∂–Ω–∞ ‚ôæÔ∏è",
            "–¢–∏ - –º—ñ–π —Å–ø–æ–∫—ñ–π —Å–µ—Ä–µ–¥ –±—É—Ä—ñ üåä",
            "–ó —Ç–æ–±–æ—é —è –∑–Ω–∞–π—à–æ–≤ —Å–ø—Ä–∞–≤–∂–Ω—î —â–∞—Å—Ç—è ü•π",
            "–¢–≤–æ—î —Å–µ—Ä—Ü–µ - –º—ñ–π –Ω–∞–π—Ü—ñ–Ω–Ω—ñ—à–∏–π —Å–∫–∞—Ä–± üíé",
            "–ö–æ–∂–Ω–∞ –º–∏—Ç—å –∑ —Ç–æ–±–æ—é - —Ü–µ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ üéÅ",
            "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —è—Å–∫—Ä–∞–≤—ñ—à–∏–º üåà",
            "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑–º–µ–∂–Ω–µ, —è–∫ –æ–∫–µ–∞–Ω üåä",
            "–¢–∏ - –ø—Ä–∏—á–∏–Ω–∞ –º–æ—î—ó –ø–æ—Å–º—ñ—à–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è üòä",
            "–¢–≤–æ—è –ª—é–±–æ–≤ - –Ω–∞–π–∫—Ä–∞—â–µ, —â–æ —Å—Ç–∞–ª–æ—Å—è –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ üíù"
          ];

          this.GRID_W = 5;
          this.GRID_H = 6;
          this.bonusCosts = { destroy: 5, shuffle: 10, explosion: 20 };

          this.currentLevel = 0;
          this.grid = [];
          this.selected = [];
          this.isDragging = false;
          this.chainNumbers = [];
          this.xp = 0;
          this.xpToNext = 10;
          this.maxNumber = 8;
          this.activeBonus = null;
          this.gameState = 'playing';
          this.messageCount = 0;

          this.createFloatingHearts();
          this.initializeEventListeners();
          this.showScreen('mainMenu');
        }

        createFloatingHearts() {
          const container = document.getElementById('floatingHearts');
          const heartTypes = ['‚ù§Ô∏è', 'üíñ', 'üíï', 'üíó', 'üíì', 'üíû', 'üíò'];
          
          for (let i = 0; i < 15; i++) {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.innerHTML = heartTypes[Math.floor(Math.random() * heartTypes.length)];
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = Math.random() * 100 + 'vh';
            heart.style.animationDelay = Math.random() * 10 + 's';
            heart.style.animationDuration = (20 + Math.random() * 20) + 's';
            container.appendChild(heart);
          }
        }

        createRomanticParticle(x, y, emoji) {
          const container = document.getElementById('romanticParticles');
          const particle = document.createElement('div');
          particle.className = 'romantic-particle';
          particle.innerHTML = emoji;
          particle.style.left = x + 'px';
          particle.style.top = y + 'px';
          container.appendChild(particle);

          setTimeout(() => particle.remove(), 3000);
        }

        showScreen(screenName) {
          document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.add('hidden');
          });
          document.getElementById(screenName + 'Screen').classList.remove('hidden');
        }

        showVictoryScreen() {
          document.getElementById('victoryOverlay').classList.remove('hidden');
        }

        hideVictoryScreen() {
          document.getElementById('victoryOverlay').classList.add('hidden');
        }

        initializeEventListeners() {
          // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
          document.getElementById('playBtn').addEventListener('click', () => this.startGame());
          document.getElementById('homeBtn').addEventListener('click', () => this.showScreen('mainMenu'));
          document.getElementById('backBtn').addEventListener('click', () => this.showScreen('mainMenu'));
          document.getElementById('playAgainBtn').addEventListener('click', () => {
            this.hideVictoryScreen();
            this.startGame();
          });
          document.getElementById('closeWebAppBtn').addEventListener('click', () => this.showScreen('mainMenu'));

          // –ò–≥—Ä–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
          document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
          document.getElementById('nextLevelBtn').addEventListener('click', () => this.nextLevel());

          // –ë–æ–Ω—É—Å—ã
          document.getElementById('bonus-destroy').addEventListener('click', () => this.activateBonus('destroy'));
          document.getElementById('bonus-shuffle').addEventListener('click', () => this.activateBonus('shuffle'));
          document.getElementById('bonus-explosion').addEventListener('click', () => this.activateBonus('explosion'));

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø–æ–≤
          this.initializeSwipeHandling();
        }

        initializeSwipeHandling() {
          const grid = document.getElementById('grid');
          
          grid.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (this.gameState !== 'playing') return;
            
            const touch = e.touches[0];
            const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
            
            if (cell) {
              this.isDragging = true;
              this.handleCellStart(cell.x, cell.y);
            }
          }, { passive: false });

          document.addEventListener('touchmove', (e) => {
            if (!this.isDragging) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
            
            if (cell) {
              this.handleCellHover(cell.x, cell.y);
            }
          }, { passive: false });

          document.addEventListener('touchend', () => {
            if (this.isDragging) {
              this.handleEnd();
              this.isDragging = false;
            }
          });
        }

        getCellFromPoint(clientX, clientY) {
          const grid = document.getElementById('grid');
          const rect = grid.getBoundingClientRect();
          
          if (clientX < rect.left || clientX > rect.right || clientY < rect.top || clientY > rect.bottom) {
            return null;
          }
          
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          
          const cellWidth = rect.width / this.GRID_W;
          const cellHeight = rect.height / this.GRID_H;
          
          const cellX = Math.floor(x / cellWidth);
          const cellY = Math.floor(y / cellHeight);
          
          if (cellX >= 0 && cellX < this.GRID_W && cellY >= 0 && cellY < this.GRID_H) {
            return { x: cellX, y: cellY };
          }
          
          return null;
        }

        startGame() {
          this.initGame(0);
          this.showScreen('game');
        }

        initGame(levelNum = 0) {
          this.currentLevel = levelNum;
          const level = this.levels[this.currentLevel];
          
          this.xp = 0;
          this.xpToNext = level.xpToNext;
          this.maxNumber = level.max;
          this.selected = [];
          this.isDragging = false;
          this.chainNumbers = [];
          this.grid = [];
          this.activeBonus = null;
          this.gameState = 'playing';
          this.messageCount = 0;

          // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
          for (let x = 0; x < this.GRID_W; x++) {
            this.grid[x] = [];
            for (let y = 0; y < this.GRID_H; y++) {
              this.grid[x][y] = { 
                number: level.numbers[Math.floor(Math.random() * level.numbers.length)], 
                merged: false 
              };
            }
          }

          this.render();
          this.updateInfo();
          this.showLoveMessage("–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï");
          this.updateBonusButtons();
        }

        render() {
          const gridDiv = document.getElementById('grid');
          gridDiv.innerHTML = '';
          
          for (let y = 0; y < this.GRID_H; y++) {
            for (let x = 0; x < this.GRID_W; x++) {
              const cell = document.createElement('div');
              cell.className = 'cell';
              cell.dataset.x = x;
              cell.dataset.y = y;
              cell.dataset.number = this.grid[x][y].number;
              
              if (this.selected.some(sel => sel.x === x && sel.y === y)) {
                cell.classList.add('selected');
              }
              
              if (this.grid[x][y].merged) {
                cell.classList.add('merged');
              }
              
              cell.textContent = this.formatNumber(this.grid[x][y].number);
              gridDiv.appendChild(cell);
            }
          }
          
          this.updateXPBar();
        }

        handleCellStart(x, y) {
          if (this.gameState !== 'playing') return;
          
          if (this.activeBonus === 'destroy') {
            this.useDestroyBonus(x, y);
            return;
          }
          
          if (this.activeBonus === 'explosion') {
            this.useExplosionBonus(x, y);
            return;
          }
          
          this.selected = [{x, y}];
          this.chainNumbers = [this.grid[x][y].number];
          this.render();
        }

        handleCellHover(x, y) {
          if (!this.isDragging || this.activeBonus) return;
          
          if (this.selected.some(sel => sel.x === x && sel.y === y)) return;
          
          const last = this.selected[this.selected.length - 1];
          if (!this.isAdjacent(last, {x, y})) return;
          
          const newNum = this.grid[x][y].number;
          const prevNum = this.chainNumbers[this.chainNumbers.length - 1];
          
          if (newNum === prevNum || newNum === prevNum * 2 || prevNum === newNum * 2) {
            this.selected.push({x, y});
            this.chainNumbers.push(newNum);
            this.render();
          }
        }

        handleEnd() {
          if (!this.isDragging) return;
          
          if (this.selected.length >= 2) {
            this.mergeChain();
          } else {
            this.selected = [];
            this.chainNumbers = [];
            this.render();
          }
        }

        isAdjacent(a, b) {
          return Math.abs(a.x - b.x) <= 1 && Math.abs(a.y - b.y) <= 1;
        }

        mergeChain() {
          const last = this.selected[this.selected.length - 1];
          const newValue = this.chainNumbers.reduce((sum, val) => sum + val, 0);
          
          if (!this.isValidResultNumber(newValue)) {
            this.showLoveMessage("–°–ø—Ä–æ–±—É–π —ñ–Ω—à—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—é, –∫–æ—Ö–∞–Ω–∞! üíï");
            this.selected = [];
            this.chainNumbers = [];
            this.render();
            return;
          }
          
          this.grid[last.x][last.y].number = newValue;
          this.grid[last.x][last.y].merged = true;
          
          for (let i = 0; i < this.selected.length - 1; i++) {
            const {x, y} = this.selected[i];
            this.grid[x][y].number = this.getRandomInitialNumber();
          }
          
          const xpEarned = this.calculateXP(this.selected.length);
          this.xp += xpEarned;
          
          this.showRandomLoveMessage(this.selected.length);
          
          setTimeout(() => {
            for (let x = 0; x < this.GRID_W; x++) {
              for (let y = 0; y < this.GRID_H; y++) {
                this.grid[x][y].merged = false;
              }
            }
            
            this.render();
            this.checkWin();
          }, 300);
          
          this.selected = [];
          this.chainNumbers = [];
          this.updateInfo();
          this.updateBonusButtons();
        }

        showRandomLoveMessage(chainLength) {
          this.messageCount++;
          document.getElementById('messageCount').textContent = this.messageCount;
          
          let message;
          if (chainLength >= 6) {
            message = "–í–∞—É! –¢–∏ –≥–µ–Ω—ñ–π –∫–æ—Ö–∞–Ω–Ω—è! üíñ –ù–∞—à–∞ –ª—é–±–æ–≤ —Ç–∞–∫–∞ –∂ —Å–∏–ª—å–Ω–∞!";
          } else if (chainLength >= 4) {
            message = "–ß—É–¥–æ–≤–æ! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ä–æ—Å—Ç–µ —è–∫ —Ç–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏! üåü";
          } else {
            message = this.loveMessages[Math.floor(Math.random() * this.loveMessages.length)];
          }
          
          this.showLoveMessage(message);
          this.createHeartsAnimation();
        }

        showLoveMessage(text) {
          document.getElementById('messageText').textContent = text;
        }

        createHeartsAnimation() {
          const heartsContainer = document.getElementById('hearts');
          heartsContainer.innerHTML = '';
          
          for (let i = 0; i < 5; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = '‚ù§Ô∏è';
            heart.style.left = Math.random() * 80 + 10 + '%';
            heart.style.animationDelay = Math.random() * 0.5 + 's';
            heartsContainer.appendChild(heart);
          }
        }

        formatNumber(num) {
          if (num >= 1000) return (num/1000).toFixed(1) + 'K';
          return num;
        }

        isValidResultNumber(num) {
          const level = this.levels[this.currentLevel];
          return level.numbers.includes(num) || level.newNumbers.includes(num);
        }

        getRandomInitialNumber() {
          const level = this.levels[this.currentLevel];
          return level.numbers[Math.floor(Math.random() * level.numbers.length)];
        }

        calculateXP(chainLen) {
          if (chainLen === 2) return 1;
          if (chainLen === 3) return 4;
          if (chainLen === 4) return 8;
          if (chainLen === 5) return 15;
          return 25;
        }

        updateXPBar() {
          const xpBar = document.getElementById('xpBar');
          const xpText = document.getElementById('xpText');
          const percent = Math.min(1, this.xp / this.xpToNext);
          
          xpBar.style.width = (percent * 100) + '%';
          xpText.textContent = `${this.xp}/${this.xpToNext}`;
        }

        updateInfo() {
          const level = this.levels[this.currentLevel];
          document.getElementById('currentLevel').textContent = this.currentLevel + 1;
          document.getElementById('targetValue').textContent = this.formatNumber(level.target);
        }

        activateBonus(bonusType) {
          if (this.activeBonus === bonusType) {
            this.activeBonus = null;
            this.updateBonusButtons();
            return;
          }
          
          if (this.xp < this.bonusCosts[bonusType]) {
            this.showLoveMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –æ—á–∫—ñ–≤ –∫–æ—Ö–∞–Ω–Ω—è! ‚ù§Ô∏è‚Äçüî•");
            return;
          }
          
          if (bonusType === 'shuffle') {
            this.xp -= this.bonusCosts.shuffle;
            this.shuffleGrid();
            this.showLoveMessage("–ü–æ–ª–µ –ø–µ—Ä–µ–º—ñ—à–∞–Ω–æ –∑ –ª—é–±–æ–≤'—é! üí´");
            this.updateBonusButtons();
            return;
          }
          
          this.activeBonus = bonusType;
          this.updateBonusButtons();
          this.showLoveMessage("–ë–æ–Ω—É—Å –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! üí´");
        }

        shuffleGrid() {
          const all = [];
          for (let x = 0; x < this.GRID_W; x++) {
            for (let y = 0; y < this.GRID_H; y++) {
              all.push(this.grid[x][y].number);
            }
          }
          
          for (let i = all.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [all[i], all[j]] = [all[j], all[i]];
          }
          
          let k = 0;
          for (let x = 0; x < this.GRID_W; x++) {
            for (let y = 0; y < this.GRID_H; y++) {
              this.grid[x][y].number = all[k++];
            }
          }
          
          this.render();
        }

        useDestroyBonus(x, y) {
          this.grid[x][y].number = this.getRandomInitialNumber();
          this.xp -= this.bonusCosts.destroy;
          this.activeBonus = null;
          this.updateBonusButtons();
          this.render();
          this.updateInfo();
          this.showLoveMessage("–ö–ª—ñ—Ç–∏–Ω–∫—É —Ä–æ–∑–±–∏—Ç–æ –∑ –ª—é–±–æ–≤'—é! üíñ");
        }

        useExplosionBonus(x, y) {
          for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
              const nx = x + dx;
              const ny = y + dy;
              
              if (nx >= 0 && nx < this.GRID_W && ny >= 0 && ny < this.GRID_H) {
                this.grid[nx][ny].number = this.getRandomInitialNumber();
              }
            }
          }
          
          this.xp -= this.bonusCosts.explosion;
          this.activeBonus = null;
          this.updateBonusButtons();
          this.render();
          this.updateInfo();
          this.showLoveMessage("–í–∏–±—É—Ö –∫–æ—Ö–∞–Ω–Ω—è! üí•‚ù§Ô∏è");
        }

        updateBonusButtons() {
          ['destroy', 'shuffle', 'explosion'].forEach(bonus => {
            const btn = document.getElementById(`bonus-${bonus}`);
            const cost = this.bonusCosts[bonus];
            
            if (this.activeBonus === bonus) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
            
            btn.disabled = this.xp < cost && this.activeBonus !== bonus;
          });
        }

        checkWin() {
          const level = this.levels[this.currentLevel];
          
          for (let x = 0; x < this.GRID_W; x++) {
            for (let y = 0; y < this.GRID_H; y++) {
              if (this.grid[x][y].number === level.target) {
                this.gameState = 'win';
                this.showLoveMessage(`–í—ñ—Ç–∞—é! –¢–∏ –¥–æ—Å—è–≥–ª–∞ —Ü—ñ–ª—ñ ${this.formatNumber(level.target)}! üéâ‚ù§Ô∏è`);
                
                if (this.currentLevel < this.MAX_LEVEL - 1) {
                  setTimeout(() => {
                    this.initGame(this.currentLevel + 1);
                    this.showLoveMessage(`–†—ñ–≤–µ–Ω—å ${this.currentLevel + 1}! –ù–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏! üåü`);
                  }, 2000);
                } else {
                  setTimeout(() => this.showVictoryScreen(), 2000);
                }
                return;
              }
            }
          }
        }

        nextLevel() {
          if (this.currentLevel < this.MAX_LEVEL - 1) {
            if (this.xp >= this.xpToNext) {
              this.initGame(this.currentLevel + 1);
              this.showLoveMessage(`–†—ñ–≤–µ–Ω—å ${this.currentLevel + 1}! –ù–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏! üåü`);
            } else {
              this.showLoveMessage(`–ü–æ—Ç—Ä—ñ–±–Ω–æ ${this.xpToNext} –æ—á–∫—ñ–≤ –∫–æ—Ö–∞–Ω–Ω—è! ‚ù§Ô∏è`);
            }
          } else {
            this.showVictoryScreen();
          }
        }

        resetGame() {
          this.initGame(this.currentLevel);
        }

        generateLevels(count) {
          const levels = [];
          let target = 64;
          let baseNumbers = [2, 4, 8];
          
          for (let i = 0; i < count; i++) {
            const level = {
              numbers: [...baseNumbers],
              target: target,
              newNumbers: this.generateNewNumbers(target),
              max: baseNumbers[baseNumbers.length - 1],
              xpToNext: 10 + Math.floor(i * 2)
            };
            
            levels.push(level);
            target *= 2;
            
            if (i % 3 === 2 && baseNumbers.length < 5) {
              baseNumbers.push(baseNumbers[baseNumbers.length - 1] * 2);
            }
          }
          
          return levels;
        }

        generateNewNumbers(target) {
          const newNumbers = [];
          let num = target / 8;
          for (let i = 0; i < 8; i++) {
            if (num <= target) {
              newNumbers.push(num);
              num *= 2;
            }
          }
          return newNumbers;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
      window.game = new LoveNumberPuzzle();
    });
  </script>
</body>
</html>