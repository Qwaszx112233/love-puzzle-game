<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üíñ Love Number Puzzle - –î–ª—è –º–æ—î—ó –∫–æ—Ö–∞–Ω–æ—ó üíñ</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ */
    .romantic-particle {
      position: absolute;
      pointer-events: none;
      font-size: 1.2em;
      z-index: 100;
      animation: romanticFloat 3s ease-in-out forwards;
    }
    
    @keyframes romanticFloat {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }
    
    .chain-line {
      position: absolute;
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
      height: 4px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 50;
      transition: all 0.3s ease;
    }
    
    .touch-glow {
      position: absolute;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(255,107,107,0.4) 0%, rgba(255,107,107,0) 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 60;
      animation: touchPulse 0.6s ease-out forwards;
    }
    
    @keyframes touchPulse {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- Enhanced Floating Hearts Background -->
  <div class="floating-hearts" id="floatingHearts"></div>
  
  <!-- Romantic Particles Container -->
  <div id="romanticParticles"></div>
  
  <!-- Victory Overlay -->
  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title">üíù –ú–æ—è –ª—é–±–æ–≤! üíù</div>
      <div class="victory-message" id="victoryMessage">–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞ –¥—Ä—É–∂–∏–Ω–∞ —É —Å–≤—ñ—Ç—ñ! üíñ</div>
      <div class="menu-buttons">
        <button class="menu-btn" id="playAgainBtn">üíï –ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="menu-btn secondary" id="closeWebAppBtn">üòò –ü–æ—Ü—ñ–ª—É–Ω–æ–∫</button>
      </div>
    </div>
  </div>
  
  <!-- Main Menu Screen -->
  <div class="screen" id="mainMenuScreen">
    <div class="game-title">üíñ Love Puzzle üíñ</div>
    <div class="romantic-subtitle">–î–ª—è –º–æ—î—ó –Ω–∞–π–∫—Ä–∞—â–æ—ó –¥—Ä—É–∂–∏–Ω–∏</div>
    <div class="menu-buttons">
      <button class="menu-btn" id="playBtn">üéÆ –ü–æ—á–∞—Ç–∏ –≥—Ä—É –∫–æ—Ö–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="settingsBtn">üíù –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="aboutBtn">üåπ –ü—Ä–æ –Ω–∞—à–µ –∫–æ—Ö–∞–Ω–Ω—è</button>
    </div>
    <div class="menu-features">
      <div class="feature-item">üíñ –Ø —Ç–µ–±–µ</div>
      <div class="feature-item">–∫–æ—Ö–∞—é</div>
      <div class="feature-item">–±—ñ–ª—å—à–µ</div>
      <div class="feature-item">–∑–∞ –≤—Å–µ üíñ</div>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="game-header">
      <div class="header-top">
        <button class="home-btn" id="homeBtn">üè† –î–æ–¥–æ–º—É</button>
        <div class="header">–ú–æ—è –ª—é–±–æ–≤, —è —Ç–µ–±–µ –æ–±–æ–∂–Ω—é—é! üíï</div>
      </div>
      <div class="love-message">
        <div class="hearts" id="hearts"></div>
        <div class="message-text" id="messageText">–ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—á–∏–∫–æ–º –ø–æ —á–∏—Å–ª–∞—Ö —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üå∏</div>
      </div>
      <div class="stats">
        <div class="stat-item">–†—ñ–≤–µ–Ω—å: <span id="currentLevel">1</span>/30</div>
        <div class="stat-item">–¶—ñ–ª—å: <span id="targetValue">64</span></div>
        <div class="stat-item">–§—Ä–∞–∑: <span id="messageCount">0</span></div>
      </div>
    </div>
    
    <div class="xp-bar">
      <div class="xp-bar-inner" id="xpBar">
        <div class="xp-bar-text" id="xpText">0/10</div>
      </div>
    </div>
    
    <div class="game-content">
      <div class="bonuses">
        <button class="bonus-btn" id="bonus-destroy">
          üíñ –†–æ–∑–±–∏—Ç–∏ <span class="bonus-cost">5</span>
        </button>
        <button class="bonus-btn" id="bonus-shuffle">
          üîÑ –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏ <span class="bonus-cost">10</span>
        </button>
        <button class="bonus-btn" id="bonus-explosion">
          üí• –í–∏–±—É—Ö –∫–æ—Ö–∞–Ω–Ω—è <span class="bonus-cost">20</span>
        </button>
      </div>
      
      <div class="level-select" id="level-select"></div>
      
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
      
      <div class="swipe-hint">üëÜ –ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –ø–æ —á–∏—Å–ª–∞—Ö –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–∞–Ω—Ü—é–∂–∫–∞</div>
      
      <div class="controls">
        <button class="btn back-btn" id="backBtn">‚Üê –î–æ –∫–æ—Ö–∞–Ω–æ—ó</button>
        <button class="btn" id="resetBtn">üîÑ –ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="btn" id="nextLevelBtn">‚≠ê –î–∞–ª—ñ –¥–æ —â–∞—Å—Ç—è</button>
      </div>
    </div>
  </div>

  <script>
    class LoveNumberPuzzle {
      constructor() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        try {
          this.tg = window.Telegram?.WebApp;
          if (this.tg) {
            console.log("Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
            this.initTelegramApp();
          } else {
            console.log("Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –≤ standalone —Ä–µ–∂–∏–º–µ");
            this.isTelegram = false;
          }
        } catch (error) {
          console.log("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App:", error);
          this.isTelegram = false;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        this.levels = this.generateLevels(30);
        this.MAX_LEVEL = this.levels.length;
        
        // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ª—é–±–æ–≤–Ω—ã—Ö —Ñ—Ä–∞–∑
        this.loveMessages = [
          "–¢–∏ - –º–æ—î —Å–æ–Ω–µ—á–∫–æ, —â–æ –æ—Å–≤—ñ—Ç–ª—é—î –∫–æ–∂–µ–Ω –º—ñ–π –¥–µ–Ω—å üåû",
          "–ö–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —Å—Ç–∞—î —Å–∏–ª—å–Ω—ñ—à–∏–º üíñ",
          "–¢–≤–æ—ó –æ—á—ñ - —Ü–µ –∑—ñ—Ä–∫–∏, —â–æ –≤–∫–∞–∑—É—é—Ç—å –º–µ–Ω—ñ —à–ª—è—Ö ‚ú®",
          "–ó —Ç–æ–±–æ—é –∫–æ–∂–Ω–∞ –º–∏—Ç—å - —Ü–µ –∫–∞–∑–∫–∞ üè∞",
          "–¢–∏ - –Ω–∞–π–Ω—ñ–∂–Ω—ñ—à–∞ –º—Ä—ñ—è –º–æ—î—ó –¥—É—à—ñ üí≠",
          "–¢–≤–æ—ó –æ–±—ñ–π–º–∏ - –º—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç ü§ó",
          "–ö–æ–∂–Ω–∞ —á–∞—Å—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ —á–∞—Ä—ñ–≤–Ω–∞ ü™Ñ",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–æ–ª–æ–¥—à–∏–º üçØ",
          "–¢–∏ - –º–æ—è —É–ª—é–±–ª–µ–Ω–∞ –ø–∞–Ω–¥–∞ —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –ø–∞–Ω–¥ üêº",
          "–õ—é–±–ª—é —Ç–µ–±–µ —Å–∏–ª—å–Ω—ñ—à–µ, –Ω—ñ–∂ –∫–æ—Ç–∏ –ª—é–±–ª—è—Ç—å –∫–æ—Ä–æ–±–∫–∏ üì¶",
          "–¢–∏ - –º–æ—î —â–∞—Å—Ç—è, —è–∫ –º–æ—Ä–æ–∑–∏–≤–æ –≤ —Å–ø–µ–∫–æ—Ç–Ω–∏–π –¥–µ–Ω—å üç¶",
          "–¢–≤–æ—è –ø–æ—Å–º—ñ—à–∫–∞ - –Ω–∞–π–∫—Ä–∞—Å–∏–≤—ñ—à–∏–π –ø–µ–π–∑–∞–∂ üòä",
          "–õ—é–±–æ–≤ –¥–æ —Ç–µ–±–µ - –≤—ñ—á–Ω–∞ —ñ –±–µ–∑–º–µ–∂–Ω–∞ ‚ôæÔ∏è",
          "–¢–∏ - –º—ñ–π —Å–ø–æ–∫—ñ–π —Å–µ—Ä–µ–¥ –±—É—Ä—ñ üåä",
          "–ó —Ç–æ–±–æ—é —è –∑–Ω–∞–π—à–æ–≤ —Å–ø—Ä–∞–≤–∂–Ω—î —â–∞—Å—Ç—è ü•π",
          "–¢–≤–æ—î —Å–µ—Ä—Ü–µ - –º—ñ–π –Ω–∞–π—Ü—ñ–Ω–Ω—ñ—à–∏–π —Å–∫–∞—Ä–± üíé",
          "–ö–æ–∂–Ω–∞ –º–∏—Ç—å –∑ —Ç–æ–±–æ—é - —Ü–µ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ üéÅ",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —è—Å–∫—Ä–∞–≤—ñ—à–∏–º üåà",
          "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑–º–µ–∂–Ω–µ, —è–∫ –æ–∫–µ–∞–Ω üåä",
          "–¢–∏ - –ø—Ä–∏—á–∏–Ω–∞ –º–æ—î—ó –ø–æ—Å–º—ñ—à–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è üòä",
          "–¢–≤–æ—è –ª—é–±–æ–≤ - –Ω–∞–π–∫—Ä–∞—â–µ, —â–æ —Å—Ç–∞–ª–æ—Å—è –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ üíù",
          "–ó —Ç–æ–±–æ—é —è –º–æ–∂—É –¥–æ—Å—è–≥—Ç–∏ –±—É–¥—å-—á–æ–≥–æ! üöÄ",
          "–¢–∏ - –º–æ—è –º—É–∑–∞ —Ç–∞ –Ω–∞—Ç—Ö–Ω–µ–Ω–Ω—è üé®",
          "–ö–æ–∂–µ–Ω –¥–µ–Ω—å –∑ —Ç–æ–±–æ—é - —Ü–µ –Ω–æ–≤–∞ –ø—Ä–∏–≥–æ–¥–∞ üó∫Ô∏è",
          "–¢–≤–æ—è –ø—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å —Ä–æ–±–∏—Ç—å –≤—Å–µ –∫—Ä–∞—â–∏–º ‚ú®",
          "–¢–∏ - –º–æ—è —Ç–∏—Ö–∞ –≥–∞–≤–∞–Ω—å —É –±—É—Ä—Ö–ª–∏–≤–æ–º—É –º–æ—Ä—ñ ‚öì",
          "–õ—é–±–ª—é —Ç–µ–±–µ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —Å–ª–æ–≤–∞ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–¥–∞—Ç–∏ üíå",
          "–¢–∏ - –º—ñ–π —â–∞—Å–ª–∏–≤–∏–π –∫–≤–∏—Ç–æ–∫ —É –∂–∏—Ç—Ç—ñ üé´",
          "–ó —Ç–æ–±–æ—é –∫–æ–∂–µ–Ω –¥–µ–Ω—å - —Å–≤—è—Ç–æ üéâ",
          "–¢–∏ - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –≤—Å—ñ –º–æ—ó –º–æ–ª–∏—Ç–≤–∏ üôè",
          // –ù–æ–≤—ã–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã
          "–ú–æ—î —Å–µ—Ä—Ü–µ –Ω–∞–ª–µ–∂–∏—Ç—å —Ç–æ–±—ñ –Ω–∞–∑–∞–≤–∂–¥–∏ üíò",
          "–¢–∏ - –º–æ—è –¥—Ä—É–≥–∞ –ø–æ–ª–æ–≤–∏–Ω–∫–∞, —è–∫—É —è —à—É–∫–∞–≤ –≤—Å–µ –∂–∏—Ç—Ç—è üíë",
          "–ö–æ–∂–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –º–æ–≥–æ —Ç—ñ–ª–∞ –ª—é–±–∏—Ç—å —Ç–µ–±–µ üî¨",
          "–¢–∏ - –º–æ—è –º—Ä—ñ—è, —è–∫–∞ –∑–±—É–ª–∞—Å—è üå†",
          "–õ—é–±–ª—é —Ç–µ–±–µ –¥–æ –º—ñ—Å—è—Ü—è —ñ –Ω–∞–∑–∞–¥ üåô",
          "–¢–≤–æ—è –ª—é–±–æ–≤ - –º–æ—è –Ω–∞–π–±—ñ–ª—å—à–∞ —Å–∏–ª–∞ üí™",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–ø—Ä–∞–≤–¥—ñ –∑–Ω–∞—á—É—â–∏–º üéØ",
          "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑ —É–º–æ–≤ —ñ –∫–æ—Ä–¥–æ–Ω—ñ–≤ üíû",
          "–¢–∏ - –Ω–∞–π–∫—Ä–∞—â–∞ –¥—Ä—É–∂–∏–Ω–∞ —É –≤—Å—ñ–π –í—Å–µ—Å–≤—ñ—Ç—ñ üåå",
          "–õ—é–±–ª—é —Ç–µ–±–µ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ –≤—á–æ—Ä–∞, –∞–ª–µ –º–µ–Ω—à–µ, –Ω—ñ–∂ –∑–∞–≤—Ç—Ä–∞ üìÖ"
        ];
        
        this.GRID_W = 5;
        this.GRID_H = 8;
        this.bonusCosts = { destroy: 5, shuffle: 10, explosion: 20 };
        
        this.currentLevel = 0;
        this.grid = [];
        this.selected = [];
        this.isDragging = false;
        this.chainNumbers = [];
        this.xp = 0;
        this.xpToNext = 10;
        this.maxNumber = 8;
        this.activeBonus = null;
        this.gameState = 'playing';
        this.messageCount = 0;
        
        // –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∫–∞—Å–∞–Ω–∏—è
        this.lastTouchPos = null;
        
        this.createEnhancedFloatingHearts();
        this.initializeEventListeners();
        this.showScreen('mainMenu');
        
        document.addEventListener('dblclick', (e) => e.preventDefault());
      }
      
      createEnhancedFloatingHearts() {
        const container = document.getElementById('floatingHearts');
        if (!container) return;
        
        const heartCount = 25; // –£–≤–µ–ª–∏—á–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–¥–µ—á–µ–∫
        container.innerHTML = '';
        
        const heartTypes = ['‚ù§Ô∏è', 'üíñ', 'üíï', 'üíó', 'üíì', 'üíû', 'üíò', 'üíù'];
        
        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement('div');
          heart.className = 'floating-heart';
          heart.innerHTML = heartTypes[Math.floor(Math.random() * heartTypes.length)];
          heart.style.left = Math.random() * 100 + 'vw';
          heart.style.top = Math.random() * 100 + 'vh';
          heart.style.animationDelay = Math.random() * 8 + 's';
          heart.style.fontSize = (Math.random() * 1 + 0.8) + 'em';
          heart.style.animationDuration = (15 + Math.random() * 15) + 's';
          container.appendChild(heart);
        }
      }
      
      createRomanticParticle(x, y, emoji) {
        const container = document.getElementById('romanticParticles');
        if (!container) return;
        
        const particle = document.createElement('div');
        particle.className = 'romantic-particle';
        particle.innerHTML = emoji;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.fontSize = (Math.random() * 1 + 1) + 'em';
        
        container.appendChild(particle);
        
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 3000);
      }
      
      createTouchGlow(x, y) {
        const glow = document.createElement('div');
        glow.className = 'touch-glow';
        glow.style.left = (x - 30) + 'px';
        glow.style.top = (y - 30) + 'px';
        
        document.body.appendChild(glow);
        
        setTimeout(() => {
          if (glow.parentNode) {
            glow.parentNode.removeChild(glow);
          }
        }, 600);
      }
      
      // –ù–æ–≤–∞—è —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π
      initializeEventListeners() {
        try {
          // Main menu buttons
          document.getElementById('playBtn').addEventListener('click', () => {
            this.startGame();
          });
          
          document.getElementById('settingsBtn').addEventListener('click', () => {
            this.showScreen('settings');
          });
          
          document.getElementById('aboutBtn').addEventListener('click', () => {
            this.showScreen('about');
          });
          
          // Home button in game screen
          document.getElementById('homeBtn').addEventListener('click', () => {
            this.showScreen('mainMenu');
          });
          
          // Back buttons
          document.getElementById('backBtn').addEventListener('click', () => {
            this.showScreen('mainMenu');
          });
          
          document.getElementById('backFromSettingsBtn').addEventListener('click', () => {
            this.showScreen('mainMenu');
          });
          
          document.getElementById('backFromAboutBtn').addEventListener('click', () => {
            this.showScreen('mainMenu');
          });
          
          // Victory screen buttons
          document.getElementById('playAgainBtn').addEventListener('click', () => {
            this.hideVictoryScreen();
            this.startGame();
          });
          
          document.getElementById('closeWebAppBtn').addEventListener('click', () => {
            if (this.isTelegram) {
              this.tg.close();
            } else {
              this.showScreen('mainMenu');
            }
          });
          
          // Settings
          document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            this.showScreen('mainMenu');
          });
          
          // Game buttons
          document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
          document.getElementById('nextLevelBtn').addEventListener('click', () => this.nextLevel());
          
          document.getElementById('bonus-destroy').addEventListener('click', () => this.activateBonus('destroy'));
          document.getElementById('bonus-shuffle').addEventListener('click', () => this.activateBonus('shuffle'));
          document.getElementById('bonus-explosion').addEventListener('click', () => this.activateBonus('explosion'));
          
          // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤ –¥–ª—è —Å–µ—Ç–∫–∏
          this.initializeSwipeHandling();
          
          document.addEventListener('contextmenu', e => e.preventDefault());
          
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π:", error);
        }
      }
      
      initializeSwipeHandling() {
        const grid = document.getElementById('grid');
        if (!grid) return;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è
        grid.addEventListener('touchstart', (e) => {
          e.preventDefault();
          if (this.gameState !== 'playing') return;
          
          const touch = e.touches[0];
          const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
          
          if (cell) {
            this.isDragging = true;
            this.lastTouchPos = { x: touch.clientX, y: touch.clientY };
            this.handleCellStart(e, cell.x, cell.y);
            this.createTouchGlow(touch.clientX, touch.clientY);
          }
        }, { passive: false });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞
        grid.addEventListener('touchmove', (e) => {
          e.preventDefault();
          if (!this.isDragging) return;
          
          const touch = e.touches[0];
          this.lastTouchPos = { x: touch.clientX, y: touch.clientY };
          
          const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
          if (cell && !this.selected.some(sel => sel.x === cell.x && sel.y === cell.y)) {
            this.handleCellHover(cell.x, cell.y);
          }
          
          // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –ø–∞–ª—å—Ü–µ–º
          this.createRomanticParticle(touch.clientX, touch.clientY, 'üíñ');
          
        }, { passive: false });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
        grid.addEventListener('touchend', (e) => {
          if (this.isDragging) {
            this.handleEnd();
            this.isDragging = false;
            this.lastTouchPos = null;
          }
        });
        
        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –º—ã—à–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        grid.addEventListener('mousedown', (e) => {
          if (this.gameState !== 'playing') return;
          
          const cell = this.getCellFromPoint(e.clientX, e.clientY);
          if (cell) {
            this.isDragging = true;
            this.handleCellStart(e, cell.x, cell.y);
            this.createTouchGlow(e.clientX, e.clientY);
          }
        });
        
        grid.addEventListener('mousemove', (e) => {
          if (!this.isDragging) return;
          
          const cell = this.getCellFromPoint(e.clientX, e.clientY);
          if (cell && !this.selected.some(sel => sel.x === cell.x && sel.y === cell.y)) {
            this.handleCellHover(cell.x, cell.y);
          }
        });
        
        grid.addEventListener('mouseup', () => {
          if (this.isDragging) {
            this.handleEnd();
            this.isDragging = false;
          }
        });
      }
      
      getCellFromPoint(clientX, clientY) {
        const grid = document.getElementById('grid');
        if (!grid) return null;
        
        const rect = grid.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        const cellWidth = rect.width / this.GRID_W;
        const cellHeight = rect.height / this.GRID_H;
        
        const cellX = Math.floor(x / cellWidth);
        const cellY = Math.floor(y / cellHeight);
        
        if (cellX >= 0 && cellX < this.GRID_W && cellY >= 0 && cellY < this.GRID_H) {
          return { x: cellX, y: cellY };
        }
        
        return null;
      }
      
      handleCellStart(e, x, y) {
        try {
          if (this.gameState !== 'playing') return;
          
          if (this.activeBonus === 'destroy') {
            this.useDestroyBonus(x, y);
            return;
          }
          
          if (this.activeBonus === 'explosion') {
            this.useExplosionBonus(x, y);
            return;
          }
          
          this.selected = [{x, y}];
          this.chainNumbers = [this.grid[x][y].number];
          this.render();
          
          // –°–æ–∑–¥–∞–µ–º —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é —á–∞—Å—Ç–∏—Ü—É
          this.createRomanticParticle(e.clientX || (e.touches && e.touches[0].clientX), 
                                    e.clientY || (e.touches && e.touches[0].clientY), 'üíï');
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞—á–∞–ª–∞ –≤—ã–±–æ—Ä–∞:", error);
        }
      }
      
      handleCellHover(x, y) {
        if (!this.isDragging || this.activeBonus) return;
        
        try {
          const last = this.selected[this.selected.length - 1];
          if (!this.isAdjacent(last, {x, y})) return;
          
          const newNum = this.grid[x][y].number;
          const prevNum = this.chainNumbers[this.chainNumbers.length - 1];
          if (newNum === prevNum || newNum === prevNum * 2 || prevNum === newNum * 2) {
            this.selected.push({x, y});
            this.chainNumbers.push(newNum);
            this.render();
            
            // –°–æ–∑–¥–∞–µ–º —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é —á–∞—Å—Ç–∏—Ü—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Ü–µ–ø–æ—á–∫—É
            if (this.lastTouchPos) {
              this.createRomanticParticle(this.lastTouchPos.x, this.lastTouchPos.y, 'üå∏');
            }
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ —è—á–µ–π–∫—É:", error);
        }
      }
      
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–∏–º–∏ –∂–µ, –Ω–æ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
      // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
      
      showRandomLoveMessage(chainLength) {
        try {
          this.messageCount++;
          document.getElementById('messageCount').textContent = this.messageCount;
          
          let message;
          if (chainLength >= 6) {
            message = "–í–∞—É! –¢–∏ –≥–µ–Ω—ñ–π –∫–æ—Ö–∞–Ω–Ω—è! üíñ –ù–∞—à–∞ –ª—é–±–æ–≤ —Ç–∞–∫–∞ –∂ —Å–∏–ª—å–Ω–∞!";
            // –°–æ–∑–¥–∞–µ–º –æ—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
            for (let i = 0; i < 10; i++) {
              setTimeout(() => {
                this.createRomanticParticle(
                  Math.random() * window.innerWidth,
                  Math.random() * window.innerHeight,
                  'üíù'
                );
              }, i * 100);
            }
          } else if (chainLength >= 4) {
            message = "–ß—É–¥–æ–≤–æ! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ä–æ—Å—Ç–µ —è–∫ —Ç–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏! üåü";
          } else {
            const randomIndex = Math.floor(Math.random() * this.loveMessages.length);
            message = this.loveMessages[randomIndex];
          }
          
          this.showLoveMessage(message);
          this.createHeartsAnimation();
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
        }
      }
      
      // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã)
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
    function initializeGame() {
      try {
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
          window.game = new LoveNumberPuzzle();
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã:", error);
        document.addEventListener('DOMContentLoaded', () => {
          window.game = new LoveNumberPuzzle();
        });
      }
    }

    initializeGame();
  </script>
</body>
</html>