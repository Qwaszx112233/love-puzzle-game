<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Love Number Puzzle - Для моєї коханої</title>
<script src="https://telegram.org/js/telegram-web-app.js?2"></script>
<style>
  body {margin:0;padding:0;overflow:hidden;background:linear-gradient(135deg,#ffafbd,#ffc3a0);font-family:Arial,sans-serif;height:100vh;}
  .romantic-particle{position:fixed;pointer-events:none;font-size:1.8rem;z-index:1000;animation:float 2.5s forwards;}
  @keyframes float{0%{transform:translateY(0) rotate(0) scale(1);opacity:1}100%{transform:translateY(-120px) rotate(360deg) scale(0);opacity:0}}
  .touch-glow{position:fixed;width:90px;height:90px;background:rgba(255,107,147,0.5);border-radius:50%;pointer-events:none;z-index:999;
    transform:translate(-50%,-50%) scale(0);animation:pulse 0.6s forwards;}
  @keyframes pulse{to{transform:translate(-50%,-50%) scale(2.5);opacity:0}}
  .grid-container{max-width:400px;margin:0 auto;padding:10px;box-sizing:border-box;}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;background:rgba(255,255,255,0.2);padding:10px;border-radius:15px;
    touch-action:none; /* КРИТИЧНО ВАЖЛИВО */}
  .cell{background:white;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;
    font-size:1.8rem;color:#e91e63;box-shadow:0 4px 10px rgba(233,30,99,0.3);transition:all .2s;position:relative;overflow:hidden;}
  .cell.selected{transform:scale(0.88);box-shadow:0 0 20px #ff4081;background:#ffebee;}
  .cell-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
  .xp-bar{background:#fff3;border-radius:10px;overflow:hidden;height:12px;margin:10px 0;}
  .xp-bar-inner{background:#e91e63;height:100%;transition:width .4s;width:0%;}
  .bonus-btn{padding:10px 15px;margin:5px;border:none;border-radius:25px;background:#e91e63;color:white;font-weight:bold;}
  .bonus-btn.active{background:#c2185b;}
  .bonus-btn:disabled{opacity:0.5;}
  .swipe-hint{color:#e91e63;font-weight:bold;text-align:center;margin:10px;}
  .hidden{display:none!important;}
</style>
</head>
<body>

<div id="romanticParticles"></div>

<!-- Victory -->
<div class="victory-overlay hidden" id="victoryOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;">
  <div style="background:white;padding:30px;border-radius:20px;text-align:center;">
    <h1>Моя любов!</h1>
    <p id="victoryMessage" style="font-size:1.3rem;">Ти пройшла всі рівні! Ти найкраща дружина у світі!</p>
    <button class="menu-btn" id="playAgainBtn" style="margin:10px;padding:15px 25px;font-size:1.2rem;">Грати знову</button>
    <button class="menu-btn secondary" id="closeWebAppBtn" style="margin:10px;padding:15px 25px;font-size:1.2rem;">Поцілунок</button>
  </div>
</div>

<!-- Main Menu -->
<div class="screen" id="mainMenuScreen" style="text-align:center;padding-top:20vh;">
  <h1 style="font-size:3rem;background:-webkit-linear-gradient(45deg,#e91e63,#ff4081);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
    Love Puzzle
  </h1>
  <p style="font-size:1.5rem;color:#e91e63;font-weight:bold;">Для моєї найкращої дружини</p>
  <button class="menu-btn" id="playBtn" style="padding:18px 40px;font-size:1.4rem;margin:20px;border:none;border-radius:30px;background:#e91e63;color:white;">Почати гру кохання</button>
</div>

<!-- Game Screen -->
<div class="screen hidden" id="gameScreen">
  <div style="padding:10px;">
    <button id="homeBtn" style="position:absolute;top:10px;left:10px;padding:10px 15px;background:#e91e63;color:white;border:none;border-radius:50%;">Додому</button>
    <div style="text-align:center;color:#e91e63;font-size:1.4rem;font-weight:bold;margin:10px;">Моя любов, я тебе обожнюю!</div>
    
    <div id="messageText" style="text-align:center;color:#e91e63;font-size:1.2rem;height:40px;">Проведи по числах!</div>
    
    <div style="display:flex;justify-content:space-around;margin:10px 0;">
      <div>Рівень: <span id="currentLevel">1</span>/30</div>
      <div>Ціль: <span id="targetValue">64</span></div>
      <div>Фраз: <span id="messageCount">0</span></div>
    </div>
    
    <div class="xp-bar"><div class="xp-bar-inner" id="xpBar"><div style="position:absolute;left:50%;transform:translateX(-50%);font-size:10px;" id="xpText">0/10</div></div></div>
    
    <div style="text-align:center;margin:10px;">
      <button class="bonus-btn" id="bonus-destroy">Розбити <span class="bonus-cost">5</span></button>
      <button class="bonus-btn" id="bonus-shuffle">Перемішати <span class="bonus-cost">10</span></button>
      <button class="bonus-btn" id="bonus-explosion">Вибух <span class="bonus-cost">20</span></button>
    </div>
    
    <div class="swipe-hint">Проведи пальцем по числах</div>
    
    <div class="grid-container">
      <div class="grid" id="grid"></div>
    </div>
    
    <div style="text-align:center;margin-top:15px;">
      <button id="resetBtn" style="padding:12px 20px;margin:5px;">Почати знову</button>
      <button id="nextLevelBtn" style="padding:12px 20px;margin:5px;">Далі</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.enableClosingConfirmation(); }

  class Game {
    constructor() {
      this.W = 5; this.H = 8;
      this.grid = [];
      this.selected = [];
      this.isDragging = false;
      this.currentLevel = 0;
      this.xp = 0;
      this.messageCount = 0;
      this.activeBonus = null;

      this.levels = this.genLevels();
      this.loveMessages = ["Ти моє сонечко","Ти найкраща дружина у світі","Люблю тебе безмежно","Ти моє щастя","Твої очі — мої зірки","З тобою я найщасливіший","Ти моє все","Ти ідеальна","Обожнюю тебе","Ти моє диво","Моє серце твоє назавжди","Ти моя мрія","Ти чарівна","Ти моє кохання","Ти моя доля","Ти мій світ","Ти мій скарб","Ти моє натхнення","Ти моя любов","Ти моя королева"];

      this.initGrid();
      this.bindEvents();
      this.render();
      this.updateUI();
    }

    genLevels() {
      const levels = [];
      let target = 64;
      let bases = [2,4,8];
      for(let i=0;i<30;i++){
        levels.push({numbers:[...bases],target,xpNeed:10+i*3});
        target *= 2;
        if(i%4===3 && bases.length<6) bases.push(bases.at(-1)*2);
      }
      return levels;
    }

    initGrid() {
      const nums = this.levels[this.currentLevel].numbers;
      this.grid = Array(this.W).fill().map(()=>Array(this.H).fill().map(()=>nums[Math.random()*nums.length|0]));
    }

    bindEvents() {
      const grid = document.getElementById('grid');

      const getCell = (clientX, clientY) => {
        const rect = grid.getBoundingClientRect();
        const x = (clientX - rect.left) / rect.width * this.W | 0;
        const y = (clientY - rect.top) / rect.height * this.H | 0;
        if(x>=0&&x<this.W&&y>=0&&y<this.H) return {x,y};
        return null;
      };

      let lastCell = null;

      const start = e => {
        if(this.activeBonus) return;
        const touch = e.touches ? e.touches[0] : e;
        const cell = getCell(touch.clientX, touch.clientY);
        if(!cell) return;
        e.preventDefault();

        this.isDragging = true;
        this.selected = [cell];
        lastCell = cell;
        this.render();
        this.glow(touch.clientX, touch.clientY);
      };

      const move = e => {
        if(!this.isDragging || this.activeBonus) return;
        const touch = e.touches ? e.touches[0] : e;
        const cell = getCell(touch.clientX, touch.clientY);
        if(!cell || !lastCell) return;

        const dx = Math.abs(cell.x - lastCell.x);
        const dy = Math.abs(cell.y - lastCell.y);
        if(dx<=1 && dy<=1 && !(dx===0&&dy===0)){
          if(!this.selected.some(c=>c.x===cell.x&&c.y===cell.y)){
            const prev = this.grid[this.selected.at(-1).x][this.selected.at(-1).y];
            const cur = this.grid[cell.x][cell.y];
            if(cur===prev || cur===prev*2 || prev===cur*2){
              this.selected.push(cell);
              lastCell = cell;
              this.render();
              this.particle(touch.clientX, touch.clientY);
            }
          }
        }
      };

      const end = () => {
        if(this.isDragging && this.selected.length>=2){
          this.merge();
        }else{
          this.selected = [];
          this.render();
        }
        this.isDragging = false;
      };

      grid.addEventListener('touchstart', start, {passive:false});
      grid.addEventListener('touchmove', move, {passive:false});
      grid.addEventListener('touchend', end);
      grid.addEventListener('mousedown', start);
      grid.addEventListener('mousemove', move);
      grid.addEventListener('mouseup', end);
      grid.addEventListener('mouseleave', end);

      document.getElementById('playBtn').onclick = () => {document.getElementById('mainMenuScreen').classList.add('hidden');document.getElementById('gameScreen').classList.remove('hidden');};
      document.getElementById('homeBtn').onclick = () => {location.reload();};
      document.getElementById('resetBtn').onclick = () => {this.initGrid();this.selected=[];this.render();};
      document.getElementById('nextLevelBtn').onclick = () => {if(this.currentLevel<29){this.currentLevel++;this.xp=0;this.initGrid();this.updateUI();this.render();}else{document.getElementById('victoryOverlay').classList.remove('hidden');}};
      document.getElementById('playAgainBtn').onclick = () => location.reload();
      document.getElementById('closeWebAppBtn').onclick = () => tg?.close();

      document.getElementById('bonus-destroy').onclick = () => this.toggleBonus('destroy');
      document.getElementById('bonus-shuffle').onclick = () => this.toggleBonus('shuffle');
      document.getElementById('bonus-explosion').onclick = () => this.toggleBonus('explosion');
    }

    toggleBonus(type){
      if(this.activeBonus===type) this.activeBonus=null;
      else if(this.xp >= {destroy:5,shuffle:10,explosion:20}[type]){
        if(type==='shuffle'){this.shuffle();this.xp-=10;this.activeBonus=null;}
        else this.activeBonus=type;
      }
      this.updateBonuses();
    }

    shuffle(){
      const arr = this.grid.flat().map(c=>c).sort(()=>Math.random()-.5);
      let i=0;
      for(let x=0;x<this.W;x++)for(let y=0;y<this.H;y++)this.grid[x][y]=arr[i++];
      this.render();
    }

    merge(){
      const sum = this.selected.reduce((s,p)=>s+this.grid[p.x][p.y],0);
      const last = this.selected.at(-1);
      if(sum > 999999 || !Number.isInteger(Math.log2(sum))) {this.selected=[];this.render();return;}

      this.grid[last.x][last.y] = sum;
      for(let i=0;i<this.selected.length-1;i++){
        const p = this.selected[i];
        const nums = this.levels[this.currentLevel].numbers;
        this.grid[p.x][p.y] = nums[Math.random()*nums.length|0];
      }

      this.xp += this.selected.length>=6?25:this.selected.length>=4?10:3;
      this.messageCount++;
      document.getElementById('messageCount').textContent = this.messageCount;
      document.getElementById('messageText').textContent = this.selected.length>=6?"Вау! Ти геній кохання!":this.loveMessages[Math.random()*this.loveMessages.length|0];

      this.checkWin();
      this.updateUI();
      this.selected = [];
      this.render();
    }

    checkWin(){
      const target = this.levels[this.currentLevel].target;
      for(let x=0;x<this.W;x++)for(let y=0;y<this.H;y++)if(this.grid[x][y]===target){
        setTimeout(()=>{alert(`Вітаю! Ти досягла ${target}!`);if(this.currentLevel<29)this.currentLevel++;else document.getElementById('victoryOverlay').classList.remove('hidden');this.xp=0;this.initGrid();this.updateUI();this.render();},500);
      }
    }

    updateUI(){
      document.getElementById('currentLevel').textContent = this.currentLevel+1;
      document.getElementById('targetValue').textContent = this.levels[this.currentLevel].target;
      const need = this.levels[this.currentLevel].xpNeed;
      document.getElementById('xpBar').style.width = (this.xp/need*100)+'%';
      document.getElementById('xpText').textContent = this.xp+'/'+need;
      this.updateBonuses();
    }

    updateBonuses(){
      ['destroy','shuffle','explosion'].forEach(t=>{
        const btn=document.getElementById('bonus-'+t);
        const cost={destroy:5,shuffle:10,explosion:20}[t];
        btn.classList.toggle('active',this.activeBonus===t);
        btn.disabled = this.xp<cost && this.activeBonus!==t;
      });
    }

    render(){
      const g = document.getElementById('grid');
      g.innerHTML='';
      for(let y=0;y<this.H;y++)for(let x=0;x<this.W;x++){
        const div=document.createElement('div');
        div.className='cell';
        if(this.selected.some(p=>p.x===x&&p.y===y)) div.classList.add('selected');
        if(this.activeBonus && this.activeBonus!=='shuffle'){
          div.style.cursor='crosshair';
          div.onclick=e=>{e.stopPropagation();if(this.activeBonus==='destroy')this.destroy(x,y);else if(this.activeBonus==='explosion')this.explode(x,y);};
        }
        const inner=document.createElement('div');
        inner.className='cell-inner';
        inner.textContent=this.grid[x][y];
        div.appendChild(inner);
        g.appendChild(div);
      }
    }

    destroy(x,y){
      this.grid[x][y]=this.levels[this.currentLevel].numbers[0];
      this.xp-=5; this.activeBonus=null; this.updateUI(); this.render();
    }
    explode(x,y){
      for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
        const nx=x+dx,ny=y+dy;
        if(nx>=0&&nx<this.W&&ny>=0&&ny<this.H)this.grid[nx][ny]=this.levels[this.currentLevel].numbers[0];
      }
      this.xp-=20; this.activeBonus=null; this.updateUI(); this.render();
    }

    glow(x,y){const d=document.createElement('div');d.className='touch-glow';d.style.left=x+'px';d.style.top=y+'px';document.body.appendChild(d);setTimeout(()=>d.remove(),600);}
    particle(x,y){const d=document.createElement('div');d.className='romantic-particle';d.textContent=['Love','Heart','Heart','Heart','Heart'][Math.random()*5|0];d.style.left=x+'px';d.style.top=y+'px';document.getElementById('romanticParticles').appendChild(d);setTimeout(()=>d.remove(),2500);}
  }

  new Game();
});
</script>
</body>
</html>