<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>‚ù§Ô∏è Love Number Puzzle ‚ù§Ô∏è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
    :root {
      --primary-color: #e91e63;
      --secondary-color: #ff4081;
      --accent-color: #f8bbd9;
      --bg-color: #fff5f7;
      --text-color: #880e4f;
      --white: #ffffff;
      --shadow: 0 4px 15px rgba(233, 30, 99, 0.15);
      --cell-color: #ffeef2;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #fff5f7 0%, #ffeef2 100%);
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Telegram Header */
    .tg-header {
      background: linear-gradient(45deg, #0088cc, #00a2ff);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      font-size: 1.1em;
    }

    /* –≠–∫—Ä–∞–Ω—ã */
    .screen {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .screen.hidden {
      display: none !important;
    }

    /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
    .main-menu {
      text-align: center;
      padding: 20px 15px;
    }

    .game-title {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      animation: heartbeat 2s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
    }

    .menu-btn {
      padding: 16px 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    .menu-btn:active {
      transform: scale(0.95);
    }

    .menu-btn.secondary {
      background: var(--white);
      color: var(--primary-color);
      border: 3px solid var(--accent-color);
    }

    .menu-features {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 300px;
    }

    .feature-item {
      background: var(--white);
      padding: 12px 8px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-color);
      font-weight: 600;
    }

    /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
    .game-screen {
      justify-content: flex-start;
    }

    .game-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .header-top {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .header {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
      flex: 1;
    }

    .home-btn {
      padding: 8px 12px;
      background: var(--white);
      color: var(--primary-color);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }

    .home-btn:active {
      transform: scale(0.95);
    }

    .love-message {
      background: var(--white);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--accent-color);
      width: 100%;
    }

    .message-text {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
      line-height: 1.2;
      text-align: center;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin: 5px 0;
      gap: 5px;
    }

    .stat-item {
      text-align: center;
      background: var(--white);
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-color);
      flex: 1;
    }

    .xp-bar {
      width: 100%;
      height: 12px;
      background: #ffeef2;
      border-radius: 6px;
      margin: 8px 0;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--accent-color);
    }

    .xp-bar-inner {
      height: 100%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      width: 0%;
    }

    .xp-bar-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      color: var(--text-color);
    }

    .game-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .grid-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 3px;
      background: var(--white);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 8px;
      width: 100%;
      max-width: 400px;
      aspect-ratio: 5/8;
    }

    .cell {
      position: relative;
      background: var(--cell-color);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(233, 30, 99, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    .cell-inner {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--text-color);
      user-select: none;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .cell.selected {
      transform: scale(0.95);
      border-color: var(--secondary-color);
    }

    .cell.selected .cell-inner {
      background: var(--secondary-color);
      color: var(--white);
      border-radius: 5px;
    }

    .cell.merged .cell-inner {
      background: var(--primary-color);
      color: var(--white);
      border-radius: 5px;
      animation: pop 0.3s ease;
    }

    @keyframes pop {
      0% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∏—Å–µ–ª */
    .cell[data-number="2"] { background: #ffb6c1; }
    .cell[data-number="4"] { background: #ffd700; }
    .cell[data-number="8"] { background: #98fb98; }
    .cell[data-number="16"] { background: #87ceeb; }
    .cell[data-number="32"] { background: #da70d6; }
    .cell[data-number="64"] { background: #ffa07a; }
    .cell[data-number="128"] { background: #f0e68c; }
    .cell[data-number="256"] { background: #dda0dd; }
    .cell[data-number="512"] { background: #b0e0e6; }

    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 10px 0;
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 2px solid var(--accent-color);
    }

    .btn {
      padding: 10px 12px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      flex: 1;
      min-width: 80px;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn.back-btn {
      background: var(--white);
      color: var(--primary-color);
      border: 2px solid var(--accent-color);
    }

    .hearts {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .heart {
      position: absolute;
      font-size: 0.8rem;
      opacity: 0;
      animation: float 2s ease-in-out forwards;
    }

    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-30px) rotate(360deg); opacity: 0; }
    }

    .floating-hearts {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .floating-heart {
      position: absolute;
      font-size: 1rem;
      opacity: 0.1;
      animation: floatAround 10s linear infinite;
    }

    @keyframes floatAround {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(100px, 100px) rotate(90deg); }
      50% { transform: translate(50px, 200px) rotate(180deg); }
      75% { transform: translate(-50px, 150px) rotate(270deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }

    /* Victory Screen */
    .victory-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .victory-overlay.hidden {
      display: none !important;
    }

    .victory-content {
      background: var(--white);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(233, 30, 99, 0.3);
      text-align: center;
      max-width: 90%;
    }

    .victory-title {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .victory-message {
      font-size: 1.1rem;
      color: var(--text-color);
      margin-bottom: 30px;
    }

    /* Settings Screen */
    .settings-screen {
      text-align: center;
      padding: 20px 15px;
    }

    .settings-title {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .settings-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 300px;
    }

    .setting-item {
      background: var(--white);
      padding: 12px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: left;
    }

    .setting-label {
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 6px;
      display: block;
      font-size: 1rem;
    }

    .setting-control {
      width: 100%;
      padding: 8px;
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--white);
    }

    /* About Screen */
    .about-screen {
      text-align: center;
      padding: 20px 15px;
    }

    .about-title {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .about-content {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .about-text {
      font-size: 0.9rem;
      color: var(--text-color);
      line-height: 1.4;
      margin-bottom: 10px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
      .cell {
        min-height: 45px;
        min-width: 45px;
      }
      
      .cell-inner {
        font-size: 1rem;
      }
      
      .grid {
        gap: 2px;
        padding: 5px;
      }
      
      .game-title {
        font-size: 1.8rem;
      }
      
      .menu-btn {
        padding: 14px 18px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Telegram Header -->
  <div class="tg-header" id="tgHeader">
    üíñ Love Puzzle - –ò–≥—Ä–∞–π —Å –ª—é–±–æ–≤—å—é!
  </div>
  
  <!-- Floating Hearts Background -->
  <div class="floating-hearts" id="floatingHearts"></div>
  
  <!-- Victory Overlay -->
  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title">üéâ –í—ñ—Ç–∞—é! üéâ</div>
      <div class="victory-message" id="victoryMessage">–¢–∏ –ø—Ä–æ–π—à–ª–∞ —Ä—ñ–≤–µ–Ω—å! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞! üíù</div>
      <div class="menu-buttons">
        <button class="menu-btn" id="playAgainBtn">üîÑ –ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="menu-btn secondary" id="backToMenuBtn">üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>
      </div>
    </div>
  </div>
  
  <!-- Main Menu Screen -->
  <div class="screen" id="mainMenuScreen">
    <div class="game-title">‚ù§Ô∏è Love Puzzle ‚ù§Ô∏è</div>
    <div class="menu-buttons">
      <button class="menu-btn" id="playBtn">üéÆ –ì—Ä–∞—Ç–∏</button>
      <button class="menu-btn secondary" id="settingsBtn">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="aboutBtn">‚ÑπÔ∏è –ü—Ä–æ –≥—Ä—É</button>
    </div>
    <div class="menu-features">
      <div class="feature-item">üíñ –Ø —Ç–µ–±–µ</div>
      <div class="feature-item">–ª—é–±–∞—é</div>
      <div class="feature-item">—à–æ –∞–∂</div>
      <div class="feature-item">–∫–æ—Ö–∞—é üíñ</div>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="game-header">
      <div class="header-top">
        <button class="home-btn" id="homeBtn">üè†</button>
        <div class="header">–°–æ–Ω–µ—á–∫–æ, —è —Ç–µ–±–µ –∫–æ—Ö–∞—é ‚ù§Ô∏è</div>
      </div>
      <div class="love-message">
        <div class="hearts" id="hearts"></div>
        <div class="message-text" id="messageText">–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï</div>
      </div>
      <div class="stats">
        <div class="stat-item">–†—ñ–≤–µ–Ω—å: <span id="currentLevel">1</span>/10</div>
        <div class="stat-item">–¶—ñ–ª—å: <span id="targetValue">64</span></div>
        <div class="stat-item">–§—Ä–∞–∑: <span id="messageCount">0</span></div>
      </div>
    </div>
    
    <div class="xp-bar">
      <div class="xp-bar-inner" id="xpBar">
        <div class="xp-bar-text" id="xpText">0/10</div>
      </div>
    </div>
    
    <div class="game-content">
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
      
      <div class="controls">
        <button class="btn back-btn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn" id="resetBtn">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
        <button class="btn" id="nextLevelBtn">‚≠ê –î–∞–ª—ñ</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Screen -->
  <div class="screen settings-screen hidden" id="settingsScreen">
    <div class="settings-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚öôÔ∏è</div>
    <div class="settings-options">
      <div class="setting-item">
        <label class="setting-label">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:</label>
        <select class="setting-control" id="difficultySelect">
          <option value="easy">–õ–µ–≥–∫–∞</option>
          <option value="medium" selected>–°–µ—Ä–µ–¥–Ω—è</option>
          <option value="hard">–°–∫–ª–∞–¥–Ω–∞</option>
        </select>
      </div>
      <div class="setting-item">
        <label class="setting-label">–ó–≤—É–∫–∏:</label>
        <select class="setting-control" id="soundSelect">
          <option value="on" selected>–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
          <option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option>
        </select>
      </div>
    </div>
    <div class="menu-buttons" style="margin-top: 20px;">
      <button class="menu-btn" id="saveSettingsBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="menu-btn secondary" id="backFromSettingsBtn">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>
  
  <!-- About Screen -->
  <div class="screen about-screen hidden" id="aboutScreen">
    <div class="about-title">–ü—Ä–æ –≥—Ä—É ‚ÑπÔ∏è</div>
    <div class="about-content">
      <p class="about-text">Love Number Puzzle - —Ü–µ –≥—Ä–∞ –ø—Ä–æ –∫–æ—Ö–∞–Ω–Ω—è —Ç–∞ —á–∏—Å–ª–∞! üíï</p>
      <p class="about-text">–û–±'—î–¥–Ω—É–π—Ç–µ —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π—Ç–µ –ª—é–±–æ–≤–Ω—ñ –ø–æ—Å–ª–∞–Ω–Ω—è –¥–ª—è –≤–∞—à–æ–≥–æ –∫–æ—Ö–∞–Ω–æ–≥–æ!</p>
      <p class="about-text">üåü –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:<br>‚Ä¢ 10 —Ä—ñ–≤–Ω—ñ–≤ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ<br>‚Ä¢ –õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏<br>‚Ä¢ –ê–Ω—ñ–º–∞—Ü—ñ—ó —Å–µ—Ä–¥–µ—á–æ–∫</p>
      <p class="about-text">üéÆ –ö–µ—Ä—É–≤–∞–Ω–Ω—è:<br>‚Ä¢ –¢–æ—Ä–∫–∞–π—Ç–µ—Å—è —á–∏—Å–µ–ª<br>‚Ä¢ –°—Ç–≤–æ—Ä—é–π—Ç–µ –ª–∞–Ω—Ü—é–∂–∫–∏<br>‚Ä¢ –û–±'—î–¥–Ω—É–π—Ç–µ –æ–¥–Ω–∞–∫–æ–≤—ñ —á–∏—Å–ª–∞</p>
    </div>
    <div class="menu-buttons" style="margin-top: 20px;">
      <button class="menu-btn secondary" id="backFromAboutBtn">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <script>
    class LoveNumberPuzzle {
      constructor() {
        this.tg = window.Telegram?.WebApp || null;
        this.isTelegram = !!this.tg;
        
        if (this.tg) {
          try {
            this.tg.ready();
            this.tg.expand();
            console.log("‚úÖ Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
          } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App:", e);
          }
        }
        
        this.levels = this.generateLevels(10);
        this.MAX_LEVEL = this.levels.length;
        
        this.loveMessages = [
          "–¢–∏ - –º–æ—î —Å–æ–Ω–µ—á–∫–æ, —â–æ –æ—Å–≤—ñ—Ç–ª—é—î –∫–æ–∂–µ–Ω –º—ñ–π –¥–µ–Ω—å üåû",
          "–ö–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —Å—Ç–∞—î —Å–∏–ª—å–Ω—ñ—à–∏–º üíñ",
          "–¢–≤–æ—ó –æ—á—ñ - —Ü–µ –∑—ñ—Ä–∫–∏, —â–æ –≤–∫–∞–∑—É—é—Ç—å –º–µ–Ω—ñ —à–ª—è—Ö ‚ú®",
          "–ó —Ç–æ–±–æ—é –∫–æ–∂–Ω–∞ –º–∏—Ç—å - —Ü–µ –∫–∞–∑–∫–∞ üè∞",
          "–¢–∏ - –Ω–∞–π–Ω—ñ–∂–Ω—ñ—à–∞ –º—Ä—ñ—è –º–æ—î—ó –¥—É—à—ñ üí≠",
          "–¢–≤–æ—ó –æ–±—ñ–π–º–∏ - –º—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç ü§ó",
          "–ö–æ–∂–Ω–∞ —á–∞—Å—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ —á–∞—Ä—ñ–≤–Ω–∞ ü™Ñ",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–æ–ª–æ–¥—à–∏–º üçØ",
          "–¢–∏ - –º–æ—è —É–ª—é–±–ª–µ–Ω–∞ –ø–∞–Ω–¥–∞ —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –ø–∞–Ω–¥ üêº",
          "–õ—é–±–ª—é —Ç–µ–±–µ —Å–∏–ª—å–Ω—ñ—à–µ, –Ω—ñ–∂ –∫–æ—Ç–∏ –ª—é–±–ª—è—Ç—å –∫–æ—Ä–æ–±–∫–∏ üì¶"
        ];
        
        this.GRID_W = 5;
        this.GRID_H = 8;
        
        this.currentLevel = 0;
        this.grid = [];
        this.selected = [];
        this.isDragging = false;
        this.chainNumbers = [];
        this.xp = 0;
        this.xpToNext = 10;
        this.maxNumber = 8;
        this.gameState = 'playing';
        this.messageCount = 0;
        
        this.handleEndBound = null;
        this.handleMoveBound = null;
        
        this.createFloatingHearts();
        this.initializeEventListeners();
        this.showScreen('mainMenu');
        
        console.log("‚úÖ –ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!");
      }
      
      generateLevels(count) {
        const levels = [];
        let target = 64;
        let baseNumbers = [2, 4, 8];
        
        for (let i = 0; i < count; i++) {
          const level = {
            numbers: [...baseNumbers],
            target: target,
            max: baseNumbers[baseNumbers.length - 1],
            xpToNext: 10 + Math.floor(i * 2)
          };
          
          levels.push(level);
          target *= 2;
          
          if (i % 3 === 2 && baseNumbers.length < 5) {
            baseNumbers.push(baseNumbers[baseNumbers.length - 1] * 2);
          }
        }
        
        return levels;
      }
      
      createFloatingHearts() {
        const container = document.getElementById('floatingHearts');
        if (!container) return;
        
        const heartCount = 8;
        
        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement('div');
          heart.className = 'floating-heart';
          heart.innerHTML = '‚ù§Ô∏è';
          heart.style.left = Math.random() * 100 + 'vw';
          heart.style.top = Math.random() * 100 + 'vh';
          heart.style.animationDelay = Math.random() * 5 + 's';
          container.appendChild(heart);
        }
      }
      
      showScreen(screenName) {
        console.log("–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω –Ω–∞:", screenName);
        
        const screens = ['mainMenu', 'game', 'settings', 'about'];
        screens.forEach(screen => {
          const element = document.getElementById(screen + 'Screen');
          if (element) {
            element.classList.add('hidden');
          }
        });
        
        const victoryOverlay = document.getElementById('victoryOverlay');
        if (victoryOverlay) {
          victoryOverlay.classList.add('hidden');
        }
        
        const targetScreen = document.getElementById(screenName + 'Screen');
        if (targetScreen) {
          targetScreen.classList.remove('hidden');
          console.log("‚úÖ –≠–∫—Ä–∞–Ω –ø–æ–∫–∞–∑–∞–Ω:", screenName);
        }
        
        if (screenName === 'game') {
          setTimeout(() => {
            this.initGame();
          }, 100);
        }
      }
      
      initGame(levelNum = 0) {
        console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã, —É—Ä–æ–≤–µ–Ω—å:", levelNum);
        
        this.currentLevel = levelNum;
        const level = this.levels[this.currentLevel];
        
        this.xp = 0;
        this.xpToNext = level.xpToNext;
        this.maxNumber = level.max;
        this.selected = [];
        this.isDragging = false;
        this.chainNumbers = [];
        this.grid = [];
        this.gameState = 'playing';
        this.messageCount = 0;
        
        for (let x = 0; x < this.GRID_W; x++) {
          this.grid[x] = [];
          for (let y = 0; y < this.GRID_H; y++) {
            this.grid[x][y] = { 
              number: level.numbers[Math.floor(Math.random() * level.numbers.length)], 
              merged: false 
            };
          }
        }
        
        this.render();
        this.updateInfo();
        this.showLoveMessage("–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï");
      }

      render() {
        const gridDiv = document.getElementById('grid');
        if (!gridDiv) return;
        
        gridDiv.innerHTML = '';
        
        for (let y = 0; y < this.GRID_H; y++) {
          for (let x = 0; x < this.GRID_W; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.dataset.number = this.grid[x][y].number;
            
            if (this.selected.some(sel => sel.x === x && sel.y === y)) {
              cell.classList.add('selected');
            }
            
            if (this.grid[x][y].merged) {
              cell.classList.add('merged');
            }
            
            cell.addEventListener('mousedown', (e) => this.handleCellStart(e, x, y));
            cell.addEventListener('mouseenter', (e) => this.handleCellHover(e, x, y));
            
            cell.addEventListener('touchstart', (e) => {
              e.preventDefault();
              this.handleCellStart(e, x, y);
            });
            
            cell.addEventListener('touchmove', (e) => {
              e.preventDefault();
              this.handleTouchMove(e);
            });

            const inner = document.createElement('div');
            inner.className = 'cell-inner';
            inner.textContent = this.grid[x][y].number;
            cell.appendChild(inner);
            
            gridDiv.appendChild(cell);
          }
        }

        this.setupGlobalHandlers();
        this.updateXPBar();
      }

      setupGlobalHandlers() {
        if (this.handleEndBound) {
          document.removeEventListener('mouseup', this.handleEndBound);
          document.removeEventListener('touchend', this.handleEndBound);
          document.removeEventListener('mousemove', this.handleMoveBound);
          document.removeEventListener('touchmove', this.handleMoveBound);
        }
        
        this.handleEndBound = this.handleEnd.bind(this);
        this.handleMoveBound = this.handleMove.bind(this);
        
        document.addEventListener('mouseup', this.handleEndBound);
        document.addEventListener('touchend', this.handleEndBound);
        document.addEventListener('mousemove', this.handleMoveBound);
        document.addEventListener('touchmove', this.handleMoveBound, { passive: false });
      }

      handleCellStart(e, x, y) {
        e.preventDefault();
        if (this.gameState !== 'playing') return;
        
        this.selected = [{x, y}];
        this.chainNumbers = [this.grid[x][y].number];
        this.isDragging = true;
        this.render();
      }

      handleCellHover(e, x, y) {
        if (!this.isDragging) return;
        
        if (this.selected.some(sel => sel.x === x && sel.y === y)) return;
        
        const last = this.selected[this.selected.length - 1];
        
        if (!this.isAdjacent(last, {x, y})) return;
        
        const newNum = this.grid[x][y].number;
        const prevNum = this.chainNumbers[this.chainNumbers.length - 1];
        
        if (newNum === prevNum || newNum === prevNum * 2 || prevNum === newNum * 2) {
          this.selected.push({x, y});
          this.chainNumbers.push(newNum);
          this.render();
        }
      }

      handleMove(e) {
        if (!this.isDragging) return;
        
        e.preventDefault();
        let clientX, clientY;
        
        if (e.type === 'mousemove') {
          clientX = e.clientX;
          clientY = e.clientY;
        } else if (e.type === 'touchmove') {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        }
        
        if (!clientX || !clientY) return;
        
        const element = document.elementFromPoint(clientX, clientY);
        if (element && element.classList.contains('cell')) {
          const x = parseInt(element.dataset.x);
          const y = parseInt(element.dataset.y);
          this.handleCellHover(e, x, y);
        }
      }

      handleTouchMove(e) {
        if (!this.isDragging) return;
        
        e.preventDefault();
        const touch = e.touches[0];
        const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
        
        for (let element of elements) {
          if (element.classList.contains('cell')) {
            const x = parseInt(element.dataset.x);
            const y = parseInt(element.dataset.y);
            
            if (this.selected.some(sel => sel.x === x && sel.y === y)) continue;
            
            const last = this.selected[this.selected.length - 1];
            
            if (!this.isAdjacent(last, {x, y})) continue;
            
            const newNum = this.grid[x][y].number;
            const prevNum = this.chainNumbers[this.chainNumbers.length - 1];
            
            if (newNum === prevNum || newNum === prevNum * 2 || prevNum === newNum * 2) {
              this.selected.push({x, y});
              this.chainNumbers.push(newNum);
              this.render();
              break;
            }
          }
        }
      }

      handleEnd() {
        if (!this.isDragging) return;
        
        if (this.selected.length >= 2) {
          this.mergeChain();
        } else {
          this.selected = [];
          this.chainNumbers = [];
          this.render();
        }
        
        this.isDragging = false;
      }

      isAdjacent(a, b) {
        const dx = Math.abs(a.x - b.x);
        const dy = Math.abs(a.y - b.y);
        return (dx <= 1 && dy <= 1) && !(dx === 0 && dy === 0);
      }

      mergeChain() {
        const lastCell = this.selected[this.selected.length - 1];
        let newValue;
        
        if (this.areAllNumbersEqual(this.chainNumbers)) {
          newValue = this.chainNumbers[0] * this.chainNumbers.length;
        } else {
          newValue = this.calculateChainValue(this.chainNumbers);
        }
        
        if (!this.isValidResultNumber(newValue)) {
          this.showLoveMessage("–°–ø—Ä–æ–±—É–π —ñ–Ω—à—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—é! üíï");
          this.selected = [];
          this.chainNumbers = [];
          this.render();
          return;
        }
        
        this.grid[lastCell.x][lastCell.y].number = newValue;
        this.grid[lastCell.x][lastCell.y].merged = true;
        
        for (let i = 0; i < this.selected.length - 1; i++) {
          const {x, y} = this.selected[i];
          this.grid[x][y].number = this.getRandomInitialNumber();
          this.grid[x][y].merged = false;
        }
        
        const xpEarned = this.calculateXP(this.selected.length);
        this.xp += xpEarned;
        
        this.showRandomLoveMessage(this.selected.length);
        
        if (newValue > this.maxNumber) {
          this.maxNumber = newValue;
        }
        
        setTimeout(() => {
          for (let x = 0; x < this.GRID_W; x++) {
            for (let y = 0; y < this.GRID_H; y++) {
              this.grid[x][y].merged = false;
            }
          }
          
          this.selected = [];
          this.chainNumbers = [];
          this.render();
          this.checkWin();
        }, 500);
        
        this.updateInfo();
      }

      areAllNumbersEqual(numbers) {
        if (numbers.length <= 1) return true;
        const first = numbers[0];
        return numbers.every(num => num === first);
      }

      calculateChainValue(numbers) {
        if (numbers.length === 2) {
          return numbers[0] + numbers[1];
        } else {
          let result = numbers[0];
          for (let i = 1; i < numbers.length; i++) {
            if (numbers[i] === result * 2 || result === numbers[i] * 2) {
              result = Math.max(result, numbers[i]) * 1.5;
            } else {
              result += numbers[i];
            }
          }
          return Math.round(result);
        }
      }

      isValidResultNumber(num) {
        const level = this.levels[this.currentLevel];
        const minNumber = Math.min(...level.numbers);
        return num >= minNumber && num <= level.target * 2;
      }

      getRandomInitialNumber() {
        const level = this.levels[this.currentLevel];
        return level.numbers[Math.floor(Math.random() * level.numbers.length)];
      }

      calculateXP(chainLen) {
        if (chainLen === 2) return 1;
        if (chainLen === 3) return 3;
        if (chainLen === 4) return 6;
        if (chainLen === 5) return 10;
        if (chainLen >= 6) return 15;
        return 0;
      }

      showRandomLoveMessage(chainLength) {
        this.messageCount++;
        document.getElementById('messageCount').textContent = this.messageCount;
        
        let message;
        if (chainLength >= 6) {
          message = "–í–∞—É! –¢–∏ –≥–µ–Ω—ñ–π –∫–æ—Ö–∞–Ω–Ω—è! üíñ –ù–∞—à–∞ –ª—é–±–æ–≤ —Ç–∞–∫–∞ –∂ —Å–∏–ª—å–Ω–∞!";
        } else if (chainLength >= 4) {
          message = "–ß—É–¥–æ–≤–æ! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ä–æ—Å—Ç–µ —è–∫ —Ç–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏! üåü";
        } else {
          const randomIndex = Math.floor(Math.random() * this.loveMessages.length);
          message = this.loveMessages[randomIndex];
        }
        
        this.showLoveMessage(message);
        this.createHeartsAnimation();
      }

      createHeartsAnimation() {
        const heartsContainer = document.getElementById('hearts');
        if (!heartsContainer) return;
        
        heartsContainer.innerHTML = '';
        const heartCount = 3;
        
        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement('div');
          heart.className = 'heart';
          heart.innerHTML = '‚ù§Ô∏è';
          heart.style.left = Math.random() * 80 + 10 + '%';
          heart.style.animationDelay = Math.random() * 0.5 + 's';
          heartsContainer.appendChild(heart);
        }
      }

      checkWin() {
        const level = this.levels[this.currentLevel];
        let targetReached = false;
        
        for (let x = 0; x < this.GRID_W; x++) {
          for (let y = 0; y < this.GRID_H; y++) {
            if (this.grid[x][y].number === level.target) {
              targetReached = true;
              break;
            }
          }
          if (targetReached) break;
        }
        
        if (targetReached && this.gameState === 'playing') {
          this.gameState = 'win';
          this.showLoveMessage(`–í—ñ—Ç–∞—é! –¢–∏ –¥–æ—Å—è–≥–ª–∞ —Ü—ñ–ª—ñ ${level.target}! üéâ‚ù§Ô∏è`);
          this.showVictoryScreen();
        }
      }

      showVictoryScreen() {
        const victoryOverlay = document.getElementById('victoryOverlay');
        const victoryMessage = document.getElementById('victoryMessage');
        
        if (victoryOverlay && victoryMessage) {
          victoryMessage.textContent = `–¢–∏ –ø—Ä–æ–π—à–ª–∞ —Ä—ñ–≤–µ–Ω—å ${this.currentLevel + 1}! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞! üíù`;
          victoryOverlay.classList.remove('hidden');
        }
      }
      
      updateInfo() {
        const level = this.levels[this.currentLevel];
        
        const currentLevelEl = document.getElementById('currentLevel');
        const targetValueEl = document.getElementById('targetValue');
        const messageCountEl = document.getElementById('messageCount');
        
        if (currentLevelEl) currentLevelEl.textContent = this.currentLevel + 1;
        if (targetValueEl) targetValueEl.textContent = level.target;
        if (messageCountEl) messageCountEl.textContent = this.messageCount;
      }
      
      updateXPBar() {
        const xpBar = document.getElementById('xpBar');
        const xpText = document.getElementById('xpText');
        
        if (xpBar && xpText) {
          const percent = Math.min(1, this.xp / this.xpToNext);
          xpBar.style.width = (percent * 100) + '%';
          xpText.textContent = `${this.xp}/${this.xpToNext}`;
        }
      }
      
      showLoveMessage(text) {
        const messageEl = document.getElementById('messageText');
        if (messageEl) {
          messageEl.textContent = text;
        }
      }
      
      initializeEventListeners() {
        // Main menu buttons
        const playBtn = document.getElementById('playBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const aboutBtn = document.getElementById('aboutBtn');
        
        if (playBtn) playBtn.addEventListener('click', () => {
          this.showScreen('game');
        });
        
        if (settingsBtn) settingsBtn.addEventListener('click', () => {
          this.showScreen('settings');
        });
        
        if (aboutBtn) aboutBtn.addEventListener('click', () => {
          this.showScreen('about');
        });
        
        // Game screen buttons
        const homeBtn = document.getElementById('homeBtn');
        const backBtn = document.getElementById('backBtn');
        const resetBtn = document.getElementById('resetBtn');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        
        if (homeBtn) homeBtn.addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        if (backBtn) backBtn.addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        if (resetBtn) resetBtn.addEventListener('click', () => {
          this.initGame(this.currentLevel);
        });
        
        if (nextLevelBtn) nextLevelBtn.addEventListener('click', () => {
          if (this.currentLevel < this.MAX_LEVEL - 1) {
            this.initGame(this.currentLevel + 1);
          }
        });
        
        // Settings screen buttons
        const backFromSettingsBtn = document.getElementById('backFromSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        if (backFromSettingsBtn) backFromSettingsBtn.addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        if (saveSettingsBtn) saveSettingsBtn.addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        // About screen buttons
        const backFromAboutBtn = document.getElementById('backFromAboutBtn');
        if (backFromAboutBtn) backFromAboutBtn.addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        // Victory screen buttons
        const playAgainBtn = document.getElementById('playAgainBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        
        if (playAgainBtn) playAgainBtn.addEventListener('click', () => {
          document.getElementById('victoryOverlay').classList.add('hidden');
          this.initGame(0);
        });
        
        if (backToMenuBtn) backToMenuBtn.addEventListener('click', () => {
          document.getElementById('victoryOverlay').classList.add('hidden');
          this.showScreen('mainMenu');
        });
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    document.addEventListener('DOMContentLoaded', () => {
      console.log("üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É...");
      window.game = new LoveNumberPuzzle();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Telegram
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.onEvent('viewportChanged', () => {
        window.Telegram.WebApp.expand();
      });
    }
  </script>
</body>
</html>